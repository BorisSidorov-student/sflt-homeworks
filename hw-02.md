# Домашнее задание к занятию "`Кластеризация и балансировка нагрузки`" - `Сидоров Борис`

---
---

### Задание 1
- Запустите два simple python сервера на своей виртуальной машине на разных портах
- Установите и настройте HAProxy, воспользуйтесь материалами к лекции по [ссылке](2/)
- Настройте балансировку Round-robin на 4 уровне.
- На проверку направьте конфигурационный файл haproxy, скриншоты, где видно перенаправление запросов на разные серверы при обращении к HAProxy.

---

### Решение 1
Подготовил тестовую среду для проведения работ по балансировки нагрузки, а именно:
- запустил два simple python сервера в ранее созданных директориях с файлам **`index.html`**, содержимое которых **`Server 1 Port 8888`** и **`9999`** для второго соответственно. Запускал сервера используя команду из лекции **`python3 -m http.server 8888 --bind 0.0.0.0`**
- установил сервис **HAProxy** с конфигурационным файлом
![L7_haproxy.cfg](screen/hm-02/task-1/hw-02-1.1.png)

поля с правилом **`ACL_example`** пока закомментировал,  так как по заданию пока не требуются.
проверяю работу сервиса на уровне **L7**, как было настроено изначально на примере.

![curl](screen/hm-02/task-1/hw-02-1.2.png)

да метод **`roundrobin`** работает.

Теперь, редактирую конфиуграционный файл под требование задания. Меняю режим **`mode`** с **`http`** на **`tcp`** в секции **`frontend`** и **`backend`**, а также в секции **`default`** в строке **`mode`** выставляю **`tcp`**, а в строке **`option`** меняю на **`tcplog`**. Ещё изменил опцию проверки серверов с  **`httpchk`** на **`tcp-check`**, а строку **`http-check send meth GET uri /index.html`** просто удалил, так как балансировка уже будет работоть не на уровне L7,а на уровне L4. Вместо проверки по http запросу будет выполняться простая проверка на уровне L4, сервис будет пытаться установить tcp соединения с портом сервера. Проверка реализовывается благодаря директиве **`option tcp-check`** и ключевому слову **`check`** после указания ip и порта сервера. По итогу конфигурационный файл стал таким:
[L4_haproxy.cfg](files/hw-02/task-1/haproxy.cfg)

Перезапускаю сервис **`haproxy`** через **`reload`** и пробую ещё раз обратиться к **`haproxy`** через **`curl`**
![curl](screen/hm-02/task-1/hw-02-1.3.png)

---
---

### Задание 2
- Запустите три simple python сервера на своей виртуальной машине на разных портах
- Настройте балансировку Weighted Round Robin на 7 уровне, чтобы первый сервер имел вес 2, второй - 3, а третий - 4
- HAproxy должен балансировать только тот http-трафик, который адресован домену example.local
- На проверку направьте конфигурационный файл haproxy, скриншоты, где видно перенаправление запросов на разные серверы при обращении к HAProxy c использованием домена example.local и без него.

---

### Решение 2
Создал 3й python сервер по аналогии как в первом задании, в файле **`index.html`** будет следующее наполнение **"Server 3 Port 7777"**. Запускаю сервер на порту **`7777`** для удобства восприятия.
![up server3](screen/hm-02/task-2/hw-02-2.1.png)

Так как по зданию нужно осуществить балансировку на уровне **L7**, я вернул в директиве **`mode`** параметр **`http`** в секция **`frontend`** и **`backend`** и соответствующие проверки серверов.
Для реализации балансировки трафика по заданному заголовку **`example.local`**, раскомментировал созданное правило **`acl`** и отредактировал заголовок под задачу. Так как балансировка должна работать исключительно по заголовку, директиву **`default_backend web_servers`** я закомментировал.
Для реализации балансировки по методу **Weighted round robin** в секции **`backend`** к каждому серверу добавил запись с указанием веса, например вес первого сервера должен быть равным **2** `server s1 127.0.0.1:8888 check weight 2`. Итоговый конфигурационный файл получился таким:
[haproxy.cfg](files/hw-02/task-2/haproxy.cfg)

Перезапускаю сервис **`haproxy`** и проверяю балансировку через утилиту **`curl`** с использованием заголовка **`example.local`** командой **`curl -H 'Host:example.com' http://127.0.0.1:8088`**. Для наглядности делаю небольшой флуд запросов чтоб убедиться, что развесовка по серверам работает.
![flud curl](screen/hm-02/task-2/hw-02-2.2.png)

Проверяю статистику на веб-странице статистики сервиса.
![web-stats](screen/hm-02/task-2/hw-02-2.3.png)

Вижу, что больше всего сессий было направлено на сервер **`s3`**, а он и имеет больший вес. Балансировка работает корректно.
Теперь попробую сделать запрос без заголовка как в первой задаче **`curl http://127.0.0.1:8088`**.
![curl](screen/hm-02/task-2/hw-02-2.4.png)

Получаю ответ **`503`**, что сервис недоступен и нет доступных серверов которые могут обработать данный запрос.